<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jimbo Points Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #1a202c;
        color: #e2e8f0;
      }
      .reward-card {
        background-color: #2d3748;
        border: 1px solid #4a5568;
        transition: transform 0.2s ease-in-out;
      }
      .reward-card:hover {
        transform: translateY(-5px);
      }
      .redeem-button {
        background-color: #4299e1;
        color: white;
        transition: background-color 0.2s ease-in-out;
      }
      .redeem-button:hover {
        background-color: #3182ce;
      }
      .message-box {
        background-color: #2d3748;
        border: 1px solid #4a5568;
        color: #e2e8f0;
      }
      .loading-spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid #4299e1;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="p-4 flex flex-col items-center min-h-screen">
    <div class="max-w-4xl w-full">
      <h1 class="text-4xl font-bold text-center mb-8 text-blue-400">
        RecklessJ4 Points Store
      </h1>

      <!-- Connection Status and User ID -->
      <div class="mb-6 p-4 rounded-lg shadow-md message-box">
        <p class="text-lg font-semibold mb-2">
          Connection Status:
          <span id="connectionStatus" class="font-normal text-yellow-400"
            >Connecting...</span
          >
        </p>
        <p class="text-lg font-semibold hidden">
          Your User ID:
          <span id="userIdDisplay" class="font-normal text-gray-400"
            >Loading...</span
          >
        </p>
        <p class="text-lg font-semibold">
          Twitch User:
          <span id="twitchUserDisplay" class="font-normal text-purple-400"
            >Not Logged In</span
          >
        </p>
        <div class="mt-4 flex justify-center space-x-4">
          <button
            id="twitchLoginBtn"
            class="px-4 py-2 rounded-md bg-purple-600 hover:bg-purple-700 text-white font-bold"
          >
            Login with Twitch
          </button>
          <button
            id="twitchLogoutBtn"
            class="px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-bold hidden"
          >
            Logout
          </button>
        </div>
      </div>

      <!-- Message Box for user feedback -->
      <div
        id="messageBox"
        class="hidden mb-6 p-4 rounded-lg shadow-md message-box"
      >
        <p id="messageText" class="text-center"></p>
        <button
          id="closeMessageBox"
          class="mt-4 mx-auto block px-4 py-2 rounded-md redeem-button"
        >
          Close
        </button>
      </div>
      <div
        id="rewardsContainer"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      >
        <!-- Rewards will be dynamically loaded here -->
      </div>
    </div>

    <script type="module">
      let currentUserPoints = 0;

      const firebaseConfig = {
        apiKey: "AIzaSyBb9LC0IY_ff17X7CyHJHCFr7IOXCod_hE",
        authDomain: "pointsstore-720fb.firebaseapp.com",
        projectId: "pointsstore-720fb",
        storageBucket: "pointsstore-720fb.firebasestorage.app",
        messagingSenderId: "117610795234",
        appId: "1:117610795234:web:510429704351c9fea94ebb",
        measurementId: "G-TD2SHRNSDE",
      };

      const TWITCH_CLIENT_ID = "y3abqciuv7yyu93bhkxn0t56iae4w7";

      const appId = firebaseConfig.projectId;
      const initialAuthToken = null;

      console.log("DEBUG: Using Firebase Config:", firebaseConfig);
      console.log("DEBUG: Effective appId:", appId);

      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        onSnapshot,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      let app;
      let db;
      let auth;
      let userId = "anonymous";
      let isAuthReady = false;

      // Twitch related variables
      let twitchAccessToken = null;
      let twitchUserName = null;
      let twitchUserId = null; // Twitch's internal user ID

      const initializeFirebase = async () => {
        try {
          if (!firebaseConfig || !firebaseConfig.projectId) {
            throw new Error(
              "Firebase configuration is missing or invalid. Please update the firebaseConfig object in the HTML file."
            );
          }

          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          onAuthStateChanged(auth, async (user) => {
            if (user) {
              userId = user.uid;
              console.log("Firebase authenticated. User ID:", userId);
            } else {
              console.log("No Firebase user. Attempting anonymous sign-in...");
              await signInAnonymously(auth);
              userId = auth.currentUser?.uid || crypto.randomUUID();
              console.log("Signed in anonymously. User ID:", userId);
            }
            document.getElementById("userIdDisplay").textContent = userId;
            isAuthReady = true;
            loadRewardsFromFirestore();
          });
        } catch (error) {
          console.error(
            "Error initializing Firebase or authenticating:",
            error
          );
          showMessage(
            `Error initializing application: ${error.message}. Please check the console and ensure your Firebase config is correct.`,
            "error"
          );
        }
      };

      let ws; // Declare WebSocket variable
      const SB_HOST = "127.0.0.1";
      const SB_PORT = 8080;
      const SB_URL = `ws://${SB_HOST}:${SB_PORT}/`;

      const connectionStatusSpan = document.getElementById("connectionStatus");
      const rewardsContainer = document.getElementById("rewardsContainer");
      const messageBox = document.getElementById("messageBox");
      const messageText = document.getElementById("messageText");
      const closeMessageBox = document.getElementById("closeMessageBox");
      const twitchLoginBtn = document.getElementById("twitchLoginBtn");
      const twitchLogoutBtn = document.getElementById("twitchLogoutBtn");
      const twitchUserDisplay = document.getElementById("twitchUserDisplay");

      let rewards = [];

      function showMessage(msg, type = "info") {
        messageText.textContent = msg;
        messageBox.classList.remove("hidden");
        if (type === "error") {
          messageText.classList.add("text-red-400");
          messageText.classList.remove("text-green-400", "text-yellow-400");
        } else if (type === "success") {
          messageText.classList.add("text-green-400");
          messageText.classList.remove("text-red-400", "text-yellow-400");
        } else {
          messageText.classList.add("text-yellow-400");
          messageText.classList.remove("text-red-400", "text-green-400");
        }
      }

      closeMessageBox.addEventListener("click", () => {
        messageBox.classList.add("hidden");
      });

      function connectStreamerbot() {
        if (
          ws &&
          (ws.readyState === WebSocket.OPEN ||
            ws.readyState === WebSocket.CONNECTING)
        ) {
          console.log("WebSocket already open or connecting.");
          return;
        }

        connectionStatusSpan.textContent = "Connecting...";
        connectionStatusSpan.classList.remove("text-green-400", "text-red-400");
        connectionStatusSpan.classList.add("text-yellow-400");

        ws = new WebSocket(SB_URL);

        ws.onopen = () => {
          connectionStatusSpan.textContent = "Connected";
          connectionStatusSpan.classList.remove(
            "text-yellow-400",
            "text-red-400"
          );
          connectionStatusSpan.classList.add("text-green-400");
          console.log("Connected to Streamer.bot WebSocket");

          // Manually subscribe to Custom events
          const subscribeMessage = {
            request: "Subscribe",
            id: "pointsStoreSubscription",
            events: {
              General: ["Custom"],
            },
          };
          ws.send(JSON.stringify(subscribeMessage));
          console.log("Sent subscription request for Custom events.");
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          console.log("Received message from Streamer.bot:", data);
          // Handle custom broadcast messages from Streamer.bot
          if (
            data.event &&
            data.event.source === "General" &&
            data.event.type === "Custom" &&
            data.data
          ) {
            // Assuming Streamer.bot sends a JSON object like { "type": "userPoints", "username": "...", "points": 123 }
            if (data.data.type === "userPoints") {
              const { username, points } = data.data;
              if (username === twitchUserName) {
                currentUserPoints = parseInt(points);
                console.log(`Stored ${points} points for ${username}`);
              }
            }
          }
        };

        ws.onclose = () => {
          connectionStatusSpan.textContent = "Disconnected";
          connectionStatusSpan.classList.remove(
            "text-yellow-400",
            "text-green-400"
          );
          connectionStatusSpan.classList.add("text-red-400");
          console.log("Disconnected from Streamer.bot WebSocket");
          showMessage(
            "Disconnected from Streamer.bot. Please ensure Streamer.bot is running and its WebSocket server is enabled.",
            "error"
          );
          // Attempt to reconnect after a delay
          setTimeout(connectStreamerbot, 5000);
        };

        ws.onerror = (error) => {
          console.error("Streamer.bot WebSocket Error:", error);
          connectionStatusSpan.textContent = "Error";
          connectionStatusSpan.classList.remove(
            "text-yellow-400",
            "text-green-400"
          );
          connectionStatusSpan.classList.add("text-red-400");
          showMessage(
            "Error connecting to Streamer.bot. Check console for details.",
            "error"
          );
          ws.close(); // Close the connection to trigger onclose and retry
        };
      }

      // --- Twitch OAuth Functions ---

      function handleTwitchLogin() {
        if (
          !TWITCH_CLIENT_ID ||
          TWITCH_CLIENT_ID === "YOUR_TWITCH_CLIENT_ID_HERE"
        ) {
          showMessage(
            "Twitch Client ID is not configured. Please get it from dev.twitch.tv.",
            "error"
          );
          return;
        }

        const redirectUri = window.location.href;
        const scopes = "user:read:email"; // Basic scope to get user info

        const twitchAuthUrl = `https://id.twitch.tv/oauth2/authorize?response_type=token&client_id=${TWITCH_CLIENT_ID}&redirect_uri=${redirectUri}&scope=${scopes}`;
        window.location.href = twitchAuthUrl;
      }

      async function getTwitchUserInfo(accessToken) {
        try {
          const response = await fetch("https://api.twitch.tv/helix/users", {
            headers: {
              "Client-ID": TWITCH_CLIENT_ID,
              Authorization: `Bearer ${accessToken}`,
            },
          });
          if (!response.ok) {
            throw new Error(`Twitch API error: ${response.statusText}`);
          }
          const data = await response.json();
          if (data.data && data.data.length > 0) {
            return data.data[0]; // Returns the first user object
          }
          return null;
        } catch (error) {
          console.error("Error fetching Twitch user info:", error);
          showMessage(
            `Error fetching Twitch user info: ${error.message}. Please try logging in again.`,
            "error"
          );
          return null;
        }
      }

      function setTwitchUser(userLogin, userId) {
        twitchUserName = userLogin;
        twitchUserId = userId;
        twitchUserDisplay.textContent = userLogin;
        twitchLoginBtn.classList.add("hidden");
        twitchLogoutBtn.classList.remove("hidden");
        console.log(`Twitch User Logged In: ${userLogin} (ID: ${userId})`);
        showMessage(`Logged in as Twitch user: ${userLogin}`, "success");
        // Store token and user info in sessionStorage for persistence across refreshes
        sessionStorage.setItem("twitchAccessToken", twitchAccessToken);
        sessionStorage.setItem("twitchUserName", twitchUserName);
        sessionStorage.setItem("twitchUserId", twitchUserId);
      }

      function clearTwitchUser() {
        twitchAccessToken = null;
        twitchUserName = null;
        twitchUserId = null;
        twitchUserDisplay.textContent = "Not Logged In";
        twitchLoginBtn.classList.remove("hidden");
        twitchLogoutBtn.classList.add("hidden");
        sessionStorage.removeItem("twitchAccessToken");
        sessionStorage.removeItem("twitchUserName");
        sessionStorage.removeItem("twitchUserId");
        showMessage("Logged out from Twitch.", "info");
      }

      // --- Handle page load / Twitch redirect ---
      async function checkTwitchAuthOnLoad() {
        const fragment = new URLSearchParams(window.location.hash.substring(1));
        const storedAccessToken = sessionStorage.getItem("twitchAccessToken");
        const storedUserName = sessionStorage.getItem("twitchUserName");
        const storedUserId = sessionStorage.getItem("twitchUserId");

        if (fragment.has("access_token")) {
          twitchAccessToken = fragment.get("access_token");
          // Clear the access token from the URL for security
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          );

          const userInfo = await getTwitchUserInfo(twitchAccessToken);
          if (userInfo) {
            setTwitchUser(userInfo.login, userInfo.id);
          } else {
            clearTwitchUser();
          }
        } else if (storedAccessToken && storedUserName && storedUserId) {
          // Restore from session storage if available
          twitchAccessToken = storedAccessToken;
          setTwitchUser(storedUserName, storedUserId);
        } else {
          clearTwitchUser(); // Ensure UI is reset if no token
        }
      }

      // --- Event Listeners for Twitch Buttons ---
      twitchLoginBtn.addEventListener("click", handleTwitchLogin);
      twitchLogoutBtn.addEventListener("click", clearTwitchUser);

      // --- Firestore Operations ---

      async function saveRewardsToFirestore() {
        if (!isAuthReady) {
          console.warn("Firebase not ready for saving rewards. Skipping save.");
          return;
        }
        try {
          const rewardsDocRef = doc(
            db,
            `artifacts/${appId}/users/${userId}/rewards`,
            "rewardList"
          );
          await setDoc(rewardsDocRef, { rewards: JSON.stringify(rewards) });
          console.log("Rewards saved to Firestore successfully!");
        } catch (e) {
          console.error("Error saving rewards to Firestore:", e);
          showMessage("Error saving rewards. Check console.", "error");
        }
      }

      function loadRewardsFromFirestore() {
        if (!isAuthReady) {
          console.warn(
            "Firebase not ready for loading rewards. Skipping load."
          );
          return;
        }
        const rewardsDocRef = doc(
          db,
          `artifacts/${appId}/users/${userId}/rewards`,
          "rewardList"
        );
        onSnapshot(
          rewardsDocRef,
          (docSnap) => {
            if (docSnap.exists()) {
              try {
                const data = docSnap.data();
                rewards = JSON.parse(data.rewards || "[]");
                console.log("Rewards loaded from Firestore:", rewards);
                renderRewards();
              } catch (e) {
                console.error("Error parsing rewards from Firestore:", e);
                showMessage(
                  "Error loading rewards. Data might be corrupted.",
                  "error"
                );
                rewards = [];
                renderRewards();
              }
            } else {
              console.log(
                "No rewards found in Firestore. Using default/empty list and saving them."
              );
              rewards = [
                {
                  id: "reward1",
                  name: "Shoutout",
                  cost: 100,
                  description: "Get a shoutout on stream!",
                  streamerbotActionName: "Redeem Shoutout",
                },
                {
                  id: "reward2",
                  name: "Mod for a Day (Joke)",
                  cost: 500,
                  description:
                    "Become a moderator for 24 hours (just kidding, it's a joke!)",
                  streamerbotActionName: "Redeem Mod Joke",
                },
                {
                  id: "reward3",
                  name: "Pick a Song",
                  cost: 250,
                  description:
                    "Request a song for the stream (DM after redeeming).",
                  streamerbotActionName: "Redeem Song Request",
                },
                {
                  id: "reward4",
                  name: "Hydrate Reminder",
                  cost: 50,
                  description: "Remind the streamer to hydrate!",
                  streamerbotActionName: "Redeem Hydrate Reminder",
                },
              ];
              renderRewards();
              saveRewardsToFirestore();
            }
          },
          (error) => {
            console.error("Error listening to Firestore rewards:", error);
            showMessage(
              "Error loading rewards from database. Check console.",
              "error"
            );
          }
        );
      }

      function renderRewards() {
        rewardsContainer.innerHTML = "";
        if (rewards.length === 0) {
          rewardsContainer.innerHTML =
            '<p class="text-center text-gray-400 col-span-full">No rewards available. Add some!</p>';
          return;
        }

        rewards.forEach((reward) => {
          const card = document.createElement("div");
          card.className =
            "reward-card p-6 rounded-lg shadow-lg flex flex-col justify-between";
          card.innerHTML = `
                    <div>
                        <h3 class="text-2xl font-semibold mb-2 text-blue-300">${reward.name}</h3>
                        <p class="text-gray-300 mb-4">${reward.description}</p>
                    </div>
                    <div class="mt-auto">
                        <p class="text-xl font-bold text-yellow-300 mb-4">${reward.cost} Points</p>
                        <button data-id="${reward.id}" class="redeem-button w-full py-3 rounded-md font-bold text-lg">Redeem</button>
                    </div>
                `;
          rewardsContainer.appendChild(card);
        });

        document.querySelectorAll(".redeem-button").forEach((button) => {
          button.addEventListener("click", async (event) => {
            const rewardId = event.target.dataset.id;
            const reward = rewards.find((r) => r.id === rewardId);
            if (reward) {
              await redeemReward(reward);
            }
          });
        });
      }

      // Function to send a doAction request to Streamer.bot
      async function doStreamerbotAction(actionName, args = {}) {
        if (ws.readyState !== WebSocket.OPEN) {
          throw new Error("Not connected to Streamer.bot WebSocket.");
        }

        const requestId = `sb_req_${Date.now()}_${Math.random()
          .toString(36)
          .substring(2, 9)}`;
        const actionPayload = {
          request: "DoAction",
          action: {
            name: actionName,
          },
          args: args,
          id: requestId,
        };

        return new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            reject(new Error(`Streamer.bot action '${actionName}' timed out.`));
          }, 5000); // 5 second timeout

          const onMessage = (event) => {
            const response = JSON.parse(event.data);
            if (response.id === requestId) {
              clearTimeout(timeout);
              ws.removeEventListener("message", onMessage);
              if (response.status === "ok") {
                resolve(response);
              } else {
                reject(
                  new Error(
                    response.error ||
                      `Streamer.bot action '${actionName}' failed.`
                  )
                );
              }
            }
          };

          ws.addEventListener("message", onMessage);
          ws.send(JSON.stringify(actionPayload));
        });
      }

      // --- Core Redemption Logic ---
      async function redeemReward(reward) {
        if (ws.readyState !== WebSocket.OPEN) {
          showMessage(
            "Not connected to Streamer.bot. Please ensure it's running.",
            "error"
          );
          return;
        }

        // Require Twitch login for redemption
        if (!twitchUserName) {
          showMessage("Please log in with Twitch to redeem rewards.", "info");
          return;
        }

        showMessage(`Attempting redemption for ${twitchUserName}...`, "info");

        try {
          // Action 1: Deduct points using the "Currency System • Commands" action
          if (reward.cost > currentUserPoints) {
            showMessage(
              `You only have ${currentUserPoints} points. "${reward.name}" costs ${reward.cost}.`,
              "error"
            );
            return;
          }
          console.log(
            `Attempting to deduct ${reward.cost} points from ${twitchUserName} using Streamer.bot action 'Currency System • Commands'...`
          );
          await doStreamerbotAction("Currency System • Commands", {
            commandId: "8a8398ba-7401-4406-a2d8-07b1bfb4070c", // This is the CommandId for "Add Points" in your C#
            input0: -reward.cost, // Pass the negative cost to deduct
            user: twitchUserName, // The authenticated Twitch user performing the action
            target: twitchUserName, // The authenticated Twitch user whose points are being affected
            commandSource: "Twitch", // Explicitly set platform
          });

          // Action 2: Trigger the specific reward action (e.g., "Redeem Shoutout")
          console.log(
            `Attempting to trigger reward action: '${reward.streamerbotActionName}' for ${twitchUserName}`
          );
          await doStreamerbotAction(reward.streamerbotActionName, {
            username: twitchUserName, // Pass authenticated username to the reward action
            rewardName: reward.name,
          });

          showMessage(
            `Successfully redeemed "${reward.name}" for ${reward.cost} points for ${twitchUserName}!`,
            "success"
          );
        } catch (error) {
          console.error("Redemption failed:", error);
          if (error.message.includes("Action not found")) {
            showMessage(
              `Redemption failed: Streamer.bot action '${reward.streamerbotActionName}' or 'Currency System • Commands' not found. Please check your Streamer.bot setup.`,
              "error"
            );
          } else {
            showMessage(
              `Redemption failed for "${reward.name}". Error: ${error.message}. Please check Streamer.bot logs.`,
              "error"
            );
          }
        }
      }

      // Initialize Firebase and then connect to Streamer.bot
      window.onload = async () => {
        initializeFirebase();
        connectStreamerbot(); // Start Streamer.bot connection attempt
        await checkTwitchAuthOnLoad(); // Check for Twitch auth on page load
      };
    </script>
  </body>
</html>


